<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionale Cucina & Dieta</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Mobile optimizations */
        @media (max-width: 640px) {
            /* Larger touch targets for mobile */
            button, input, select {
                min-height: 44px;
            }

            /* Smoother scrolling on mobile */
            * {
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            }
        }

        /* Hide scrollbar on tab container */
        .tab-container::-webkit-scrollbar {
            display: none;
        }
        .tab-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Dark mode input styles */
        .dark-input {
            background-color: rgb(55, 65, 81);
            border-color: rgb(75, 85, 99);
            color: rgb(243, 244, 246);
        }
        .dark-input::placeholder {
            color: rgb(156, 163, 175);
        }
        .dark-input:focus {
            outline: none;
            border-color: rgb(249, 115, 22);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Icone SVG
        const Plus = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const Trash2 = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
        );

        const ShoppingCart = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="9" cy="21" r="1"></circle>
                <circle cx="20" cy="21" r="1"></circle>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg>
        );

        const Dice3 = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8" cy="8" r="1"></circle>
                <circle cx="12" cy="12" r="1"></circle>
                <circle cx="16" cy="16" r="1"></circle>
            </svg>
        );

        const Download = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

        const Upload = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
        );

        const Edit2 = () => (
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
            </svg>
        );

        const Check = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        );

        const X = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        );

        const Copy = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        );

        const Clipboard = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
            </svg>
        );

        const Sun = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
        );

        const Moon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
        );

        function CucinaApp() {
            const [activeTab, setActiveTab] = useState('ricette');
            const [ricette, setRicette] = useState([]);
            const [ingredientiDB, setIngredientiDB] = useState([]);
            const [inventario, setInventario] = useState([]);
            const [listaSpesa, setListaSpesa] = useState([]);
            const [pasti, setPasti] = useState([]);
            const [editingId, setEditingId] = useState(null);
            const [editingRecipeId, setEditingRecipeId] = useState(null);
            const [darkMode, setDarkMode] = useState(false);

            // Helper per classi dark mode
            const inputClass = (base = '') => `${base} ${darkMode ? 'dark-input' : 'bg-white border-gray-300'}`;
            const textClass = darkMode ? 'text-gray-100' : 'text-gray-800';
            const textSecondary = darkMode ? 'text-gray-300' : 'text-gray-600';
            const cardClass = darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-200';
            const bgAccent = darkMode ? 'bg-gray-600' : 'bg-gray-50';

            // Carica tema da localStorage all'avvio
            useEffect(() => {
                const savedTheme = localStorage.getItem('cucinaAppTheme');
                if (savedTheme === 'dark') {
                    setDarkMode(true);
                }
            }, []);

            // Salva tema in localStorage quando cambia
            useEffect(() => {
                localStorage.setItem('cucinaAppTheme', darkMode ? 'dark' : 'light');
            }, [darkMode]);

            // Carica dati da localStorage all'avvio
            useEffect(() => {
                const savedData = localStorage.getItem('cucinaAppData');
                if (savedData) {
                    try {
                        const data = JSON.parse(savedData);
                        if (data.ricette) setRicette(data.ricette);
                        if (data.ingredientiDB) setIngredientiDB(data.ingredientiDB);
                        if (data.inventario) setInventario(data.inventario);
                        if (data.listaSpesa) setListaSpesa(data.listaSpesa);
                        if (data.pasti) setPasti(data.pasti);
                    } catch (e) {
                        console.error('Errore nel caricamento dei dati:', e);
                    }
                }
            }, []);

            // Salva dati in localStorage quando cambiano
            useEffect(() => {
                const data = { ricette, ingredientiDB, inventario, listaSpesa, pasti };
                localStorage.setItem('cucinaAppData', JSON.stringify(data));
            }, [ricette, ingredientiDB, inventario, listaSpesa, pasti]);

            const [nuovaRicetta, setNuovaRicetta] = useState({
                nome: '',
                ingredienti: [{ nome: '', quantita: '', unita: 'g' }],
                istruzioni: '',
                grammiTotali: '',
                grammiPorzione: '',
                macro: { calorie: '', proteine: '', carboidrati: '', grassi: '' }
            });

            const unitaMisura = ['g', 'kg', 'ml', 'l', 'cucchiaio', 'cucchiaino', 'tazza', 'pz', 'fetta', 'spicchio'];

            const aggiungiRicetta = () => {
                if (!nuovaRicetta.nome) return;

                if (editingRecipeId) {
                    // Modalit√† modifica
                    setRicette(ricette.map(r =>
                        r.id === editingRecipeId
                            ? { ...r, ...nuovaRicetta, ingredienti: nuovaRicetta.ingredienti.filter(i => i.nome && i.quantita) }
                            : r
                    ));
                    setEditingRecipeId(null);
                } else {
                    // Modalit√† creazione
                    const ricetta = {
                        id: Date.now(),
                        ...nuovaRicetta,
                        ingredienti: nuovaRicetta.ingredienti.filter(i => i.nome && i.quantita)
                    };
                    setRicette([...ricette, ricetta]);
                }

                setNuovaRicetta({
                    nome: '',
                    ingredienti: [{ nome: '', quantita: '', unita: 'g' }],
                    istruzioni: '',
                    grammiTotali: '',
                    grammiPorzione: '',
                    macro: { calorie: '', proteine: '', carboidrati: '', grassi: '' }
                });
            };

            const modificaRicetta = (ricetta) => {
                setNuovaRicetta({
                    nome: ricetta.nome,
                    ingredienti: ricetta.ingredienti.length > 0 ? ricetta.ingredienti : [{ nome: '', quantita: '', unita: 'g' }],
                    istruzioni: ricetta.istruzioni || '',
                    grammiTotali: ricetta.grammiTotali || '',
                    grammiPorzione: ricetta.grammiPorzione || '',
                    macro: ricetta.macro
                });
                setEditingRecipeId(ricetta.id);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const annullaModificaRicetta = () => {
                setEditingRecipeId(null);
                setNuovaRicetta({
                    nome: '',
                    ingredienti: [{ nome: '', quantita: '', unita: 'g' }],
                    istruzioni: '',
                    grammiTotali: '',
                    grammiPorzione: '',
                    macro: { calorie: '', proteine: '', carboidrati: '', grassi: '' }
                });
            };

            const eliminaRicetta = (id) => {
                setRicette(ricette.filter(r => r.id !== id));
            };

            // Database Ingredienti
            const [nuovoIngredienteDB, setNuovoIngredienteDB] = useState({
                nome: '',
                categoria: 'Altro',
                unitaPrincipale: 'g', // g o ml
                unitaDefault: 'g',
                conversioniUnita: [], // [{ unita: 'pz', fattore: 9 }]
                macro: { calorie: '', proteine: '', carboidrati: '', grassi: '' }
            });
            const [editingIngredienteId, setEditingIngredienteId] = useState(null);
            const [filtroCategoria, setFiltroCategoria] = useState('Tutte');
            const [ordinamento, setOrdinamento] = useState('nome');

            const categorie = ['Carne', 'Pesce', 'Verdura', 'Frutta', 'Cereali', 'Legumi', 'Latticini', 'Uova', 'Oli e Grassi', 'Dolci', 'Bevande', 'Altro'];

            const aggiungiIngredienteDB = () => {
                if (!nuovoIngredienteDB.nome.trim()) {
                    alert('‚ùå Inserisci il nome dell\'ingrediente!');
                    return;
                }

                // Verifica nome univoco
                const nomeNormalizzato = nuovoIngredienteDB.nome.trim().toLowerCase();
                const esisteGia = ingredientiDB.some(ing =>
                    ing.id !== editingIngredienteId &&
                    ing.nome.toLowerCase() === nomeNormalizzato
                );

                if (esisteGia) {
                    alert('‚ùå Esiste gi√† un ingrediente con questo nome!');
                    return;
                }

                if (editingIngredienteId) {
                    // Modalit√† modifica
                    setIngredientiDB(ingredientiDB.map(ing =>
                        ing.id === editingIngredienteId
                            ? { ...ing, ...nuovoIngredienteDB, nome: nuovoIngredienteDB.nome.trim() }
                            : ing
                    ));
                    setEditingIngredienteId(null);
                } else {
                    // Modalit√† creazione
                    const ingrediente = {
                        id: Date.now(),
                        ...nuovoIngredienteDB,
                        nome: nuovoIngredienteDB.nome.trim()
                    };
                    setIngredientiDB([...ingredientiDB, ingrediente]);
                }

                // Reset form
                setNuovoIngredienteDB({
                    nome: '',
                    categoria: 'Altro',
                    unitaPrincipale: 'g',
                    unitaDefault: 'g',
                    conversioniUnita: [],
                    macro: { calorie: '', proteine: '', carboidrati: '', grassi: '' }
                });
            };

            const modificaIngrediente = (ingrediente) => {
                setNuovoIngredienteDB({
                    nome: ingrediente.nome,
                    categoria: ingrediente.categoria || 'Altro',
                    unitaPrincipale: ingrediente.unitaPrincipale || 'g',
                    unitaDefault: ingrediente.unitaDefault || 'g',
                    conversioniUnita: ingrediente.conversioniUnita || [],
                    macro: ingrediente.macro
                });
                setEditingIngredienteId(ingrediente.id);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const annullaModificaIngrediente = () => {
                setEditingIngredienteId(null);
                setNuovoIngredienteDB({
                    nome: '',
                    categoria: 'Altro',
                    unitaPrincipale: 'g',
                    unitaDefault: 'g',
                    conversioniUnita: [],
                    macro: { calorie: '', proteine: '', carboidrati: '', grassi: '' }
                });
            };

            const eliminaIngredienteDB = (id) => {
                if (!confirm('Sei sicuro di voler eliminare questo ingrediente?')) return;
                setIngredientiDB(ingredientiDB.filter(i => i.id !== id));
            };

            const aggiungiConversione = () => {
                const nuovaConversione = { unita: '', fattore: '' };
                setNuovoIngredienteDB({
                    ...nuovoIngredienteDB,
                    conversioniUnita: [...nuovoIngredienteDB.conversioniUnita, nuovaConversione]
                });
            };

            const rimuoviConversione = (index) => {
                const nuoveConversioni = [...nuovoIngredienteDB.conversioniUnita];
                nuoveConversioni.splice(index, 1);
                setNuovoIngredienteDB({
                    ...nuovoIngredienteDB,
                    conversioniUnita: nuoveConversioni
                });
            };

            const aggiornaConversione = (index, campo, valore) => {
                const nuoveConversioni = [...nuovoIngredienteDB.conversioniUnita];
                nuoveConversioni[index][campo] = valore;
                setNuovoIngredienteDB({
                    ...nuovoIngredienteDB,
                    conversioniUnita: nuoveConversioni
                });
            };

            const getIngredientiFiltrati = () => {
                let filtrati = ingredientiDB;

                // Applica filtro categoria
                if (filtroCategoria !== 'Tutte') {
                    filtrati = filtrati.filter(ing => ing.categoria === filtroCategoria);
                }

                // Applica ordinamento
                switch (ordinamento) {
                    case 'nome':
                        filtrati = [...filtrati].sort((a, b) => a.nome.localeCompare(b.nome));
                        break;
                    case 'categoria':
                        filtrati = [...filtrati].sort((a, b) => (a.categoria || 'Altro').localeCompare(b.categoria || 'Altro'));
                        break;
                    case 'calorie':
                        filtrati = [...filtrati].sort((a, b) => (parseFloat(b.macro.calorie) || 0) - (parseFloat(a.macro.calorie) || 0));
                        break;
                    case 'proteine':
                        filtrati = [...filtrati].sort((a, b) => (parseFloat(b.macro.proteine) || 0) - (parseFloat(a.macro.proteine) || 0));
                        break;
                }

                return filtrati;
            };

            const copiaIngredientiJSON = () => {
                const ingredientiValidi = nuovaRicetta.ingredienti.filter(i => i.nome && i.quantita);
                if (ingredientiValidi.length === 0) {
                    alert('Aggiungi almeno un ingrediente prima di copiare!');
                    return;
                }

                const richiesta = {
                    richiesta: "Calcola le calorie totali e i macronutrienti (proteine, carboidrati, grassi in grammi) per 100g di piatto finito di questa ricetta. Considera che gli ingredienti crudi cambiano peso dopo la cottura. Restituisci il risultato compilando il campo 'outputJson' qui sotto con i valori per 100g di piatto finito.",
                    ricetta: {
                        nome: nuovaRicetta.nome || 'Ricetta senza nome',
                        ingredienti: ingredientiValidi,
                        istruzioni: nuovaRicetta.istruzioni || ''
                    },
                    outputJson: {
                        macro: {
                            calorie: 0,
                            proteine: 0,
                            carboidrati: 0,
                            grassi: 0
                        }
                    }
                };

                const json = JSON.stringify(richiesta, null, 2);

                navigator.clipboard.writeText(json).then(() => {
                    alert('‚úÖ JSON copiato! Incollalo nella chat con Claude.\n\nClaude calcoler√† i macro per 100g di piatto finito e restituir√† il JSON gi√† pronto da incollare nell\'app.');
                }).catch(() => {
                    alert('‚ùå Errore nella copia. Prova manualmente:\n\n' + json);
                });
            };

            const incollaMacroJSON = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    const data = JSON.parse(text);

                    if (data.macro && data.macro.calorie !== undefined) {
                        setNuovaRicetta({
                            ...nuovaRicetta,
                            macro: {
                                calorie: data.macro.calorie || '',
                                proteine: data.macro.proteine || '',
                                carboidrati: data.macro.carboidrati || '',
                                grassi: data.macro.grassi || ''
                            }
                        });
                        alert('‚úÖ Macro incollati con successo!');
                    } else {
                        alert('‚ùå JSON non valido. Assicurati che contenga un oggetto "macro" con calorie, proteine, carboidrati e grassi.');
                    }
                } catch (e) {
                    alert('‚ùå Errore: ' + e.message + '\n\nIncolla un JSON valido nella forma:\n{\n  "macro": {\n    "calorie": 500,\n    "proteine": 30,\n    "carboidrati": 50,\n    "grassi": 15\n  }\n}');
                }
            };

            const aggiungiIngredienteRicetta = () => {
                setNuovaRicetta({
                    ...nuovaRicetta,
                    ingredienti: [...nuovaRicetta.ingredienti, { nome: '', quantita: '', unita: 'g' }]
                });
            };

            const rimuoviIngredienteRicetta = (index) => {
                const nuoviIng = [...nuovaRicetta.ingredienti];
                nuoviIng.splice(index, 1);
                setNuovaRicetta({ ...nuovaRicetta, ingredienti: nuoviIng });
            };

            const [nuovoItem, setNuovoItem] = useState({ nome: '', quantita: '', unita: 'g' });

            const aggiungiInventario = () => {
                if (!nuovoItem.nome || !nuovoItem.quantita) return;
                
                setInventario([...inventario, { id: Date.now(), ...nuovoItem }]);
                setNuovoItem({ nome: '', quantita: '', unita: 'g' });
            };

            const eliminaInventario = (id) => {
                setInventario(inventario.filter(i => i.id !== id));
            };

            const modificaInventario = (id, campo, valore) => {
                setInventario(inventario.map(i => 
                    i.id === id ? { ...i, [campo]: valore } : i
                ));
            };

            const [nuovoSpesa, setNuovoSpesa] = useState({ nome: '', quantita: '', unita: 'pz' });

            const aggiungiSpesa = () => {
                if (!nuovoSpesa.nome) return;
                
                setListaSpesa([...listaSpesa, { id: Date.now(), ...nuovoSpesa, comprato: false }]);
                setNuovoSpesa({ nome: '', quantita: '', unita: 'pz' });
            };

            const toggleComprato = (id) => {
                setListaSpesa(listaSpesa.map(s => 
                    s.id === id ? { ...s, comprato: !s.comprato } : s
                ));
            };

            const eliminaSpesa = (id) => {
                setListaSpesa(listaSpesa.filter(s => s.id !== id));
            };

            const generaListaSpesaDaRicetta = (ricetta) => {
                const nuoviArticoli = [];
                ricetta.ingredienti.forEach(ing => {
                    const esisteInInventario = inventario.some(i => 
                        i.nome.toLowerCase() === ing.nome.toLowerCase()
                    );
                    
                    const esisteInSpesa = listaSpesa.some(s => 
                        s.nome.toLowerCase() === ing.nome.toLowerCase()
                    );
                    
                    if (!esisteInInventario && !esisteInSpesa) {
                        nuoviArticoli.push({
                            id: Date.now() + Math.random(),
                            nome: ing.nome,
                            quantita: ing.quantita,
                            unita: ing.unita,
                            comprato: false
                        });
                    }
                });
                
                if (nuoviArticoli.length > 0) {
                    setListaSpesa([...listaSpesa, ...nuoviArticoli]);
                    alert(`Aggiunti ${nuoviArticoli.length} ingredienti alla lista spesa!`);
                } else {
                    alert('Hai gi√† tutti gli ingredienti!');
                }
            };

            const ricettaRandom = () => {
                const ricetteFattibili = ricette.filter(ricetta => {
                    return ricetta.ingredienti.every(ing => 
                        inventario.some(inv => 
                            inv.nome.toLowerCase() === ing.nome.toLowerCase()
                        )
                    );
                });

                if (ricetteFattibili.length === 0) {
                    alert('Non hai ingredienti per nessuna ricetta! üò¢');
                    return;
                }

                const random = ricetteFattibili[Math.floor(Math.random() * ricetteFattibili.length)];
                alert(`üé≤ Oggi cucini: ${random.nome}!`);
            };

            const [nuovoPasto, setNuovoPasto] = useState({
                data: new Date().toISOString().split('T')[0],
                tipoPasto: 'Pranzo',
                nome: '',
                quantita: '',
                unita: 'g',
                macro: { calorie: '', proteine: '', carboidrati: '', grassi: '' },
                isRicetta: false,
                ricettaId: null,
                ingredienteDBId: null, // Per tracciare quale ingrediente DB √® stato selezionato
                unitaDisponibili: [] // Unit√† disponibili per questo ingrediente
            });

            const tipiPasto = ['Colazione', 'Spuntino Mattina', 'Pranzo', 'Spuntino Pomeriggio', 'Pre-Workout', 'Post-Workout', 'Cena', 'Spuntino Sera'];

            // Stati per visualizzazione storico
            const [giorniEspansi, setGiorniEspansi] = useState(new Set([new Date().toISOString().split('T')[0]])); // Oggi sempre espanso
            const [giorniVisibili, setGiorniVisibili] = useState(7); // Mostra ultimi 7 giorni

            const toggleEspansioneGiorno = (data) => {
                const nuoviEspansi = new Set(giorniEspansi);
                if (nuoviEspansi.has(data)) {
                    nuoviEspansi.delete(data);
                } else {
                    nuoviEspansi.add(data);
                }
                setGiorniEspansi(nuoviEspansi);
            };

            const caricaAltriGiorni = () => {
                setGiorniVisibili(giorniVisibili + 7);
            };

            // Calcola i macro per un ingrediente in base all'unit√† e quantit√†
            const calcolaMacroIngrediente = (ingrediente, quantita, unita) => {
                const unitaPrincipale = ingrediente.unitaPrincipale || 'g';
                let fattoreConversione = 1;

                // Se l'unit√† non √® quella principale, trova il fattore di conversione
                if (unita !== unitaPrincipale && ingrediente.conversioniUnita) {
                    const conversione = ingrediente.conversioniUnita.find(c => c.unita === unita);
                    if (conversione && conversione.fattore) {
                        // Quantit√† in unit√† principale = quantit√† * fattore
                        // Es: 2 pz * 9g/pz = 18g
                        fattoreConversione = parseFloat(conversione.fattore) / 100;
                    } else {
                        // Unit√† non trovata, usa principale
                        fattoreConversione = parseFloat(quantita) / 100;
                    }
                } else {
                    // Stessa unit√† principale
                    fattoreConversione = parseFloat(quantita) / 100;
                }

                // Se √® una conversione, il fattore √® gi√† corretto
                if (unita !== unitaPrincipale) {
                    const conversione = ingrediente.conversioniUnita?.find(c => c.unita === unita);
                    if (conversione) {
                        // quantita * fattore / 100
                        const grammiTotali = parseFloat(quantita) * parseFloat(conversione.fattore);
                        fattoreConversione = grammiTotali / 100;
                    }
                }

                return {
                    calorie: Math.round((parseFloat(ingrediente.macro.calorie) || 0) * fattoreConversione),
                    proteine: ((parseFloat(ingrediente.macro.proteine) || 0) * fattoreConversione).toFixed(1),
                    carboidrati: ((parseFloat(ingrediente.macro.carboidrati) || 0) * fattoreConversione).toFixed(1),
                    grassi: ((parseFloat(ingrediente.macro.grassi) || 0) * fattoreConversione).toFixed(1)
                };
            };

            const selezionaIngredienteTracking = (ingredienteId) => {
                if (!ingredienteId) return;

                const ingDB = ingredientiDB.find(i => i.id === parseInt(ingredienteId));
                if (!ingDB) return;

                // Prepara lista unit√† disponibili
                const unitaPrincipale = ingDB.unitaPrincipale || 'g';
                const unitaDisponibili = [unitaPrincipale];

                if (ingDB.conversioniUnita && ingDB.conversioniUnita.length > 0) {
                    ingDB.conversioniUnita
                        .filter(conv => conv.unita && conv.fattore)
                        .forEach(conv => unitaDisponibili.push(conv.unita));
                }

                // Usa unit√† default dell'ingrediente
                const unitaDefault = ingDB.unitaDefault || unitaPrincipale;

                // Calcola quantit√† e macro per l'unit√† default
                let quantitaDefault = '1';
                let macroCalcolati;

                if (unitaDefault === unitaPrincipale) {
                    quantitaDefault = '100';
                    macroCalcolati = ingDB.macro;
                } else {
                    quantitaDefault = '1';
                    macroCalcolati = calcolaMacroIngrediente(ingDB, 1, unitaDefault);
                }

                setNuovoPasto({
                    ...nuovoPasto,
                    nome: ingDB.nome,
                    quantita: quantitaDefault,
                    unita: unitaDefault,
                    macro: macroCalcolati,
                    isRicetta: false,
                    ricettaId: null,
                    ingredienteDBId: ingDB.id,
                    unitaDisponibili: unitaDisponibili
                });
            };

            const aggiornaQuantitaIngrediente = (quantita) => {
                if (!nuovoPasto.ingredienteDBId) {
                    // Nessun ingrediente DB selezionato, update semplice
                    setNuovoPasto({ ...nuovoPasto, quantita });
                    return;
                }

                const ingDB = ingredientiDB.find(i => i.id === nuovoPasto.ingredienteDBId);
                if (!ingDB) {
                    setNuovoPasto({ ...nuovoPasto, quantita });
                    return;
                }

                // Ricalcola i macro
                const nuoviMacro = calcolaMacroIngrediente(ingDB, parseFloat(quantita) || 0, nuovoPasto.unita);
                setNuovoPasto({ ...nuovoPasto, quantita, macro: nuoviMacro });
            };

            const aggiornaUnitaIngrediente = (unita) => {
                if (!nuovoPasto.ingredienteDBId) {
                    setNuovoPasto({ ...nuovoPasto, unita });
                    return;
                }

                const ingDB = ingredientiDB.find(i => i.id === nuovoPasto.ingredienteDBId);
                if (!ingDB) {
                    setNuovoPasto({ ...nuovoPasto, unita });
                    return;
                }

                // Ricalcola i macro con la nuova unit√†
                const nuoviMacro = calcolaMacroIngrediente(ingDB, parseFloat(nuovoPasto.quantita) || 0, unita);
                setNuovoPasto({ ...nuovoPasto, unita, macro: nuoviMacro });
            };

            const aggiungiPasto = () => {
                if (!nuovoPasto.nome) return;

                setPasti([...pasti, { id: Date.now(), ...nuovoPasto }]);
                setNuovoPasto({
                    data: new Date().toISOString().split('T')[0],
                    tipoPasto: nuovoPasto.tipoPasto, // Mantieni lo stesso tipo pasto
                    nome: '',
                    quantita: '',
                    unita: 'g',
                    macro: { calorie: '', proteine: '', carboidrati: '', grassi: '' },
                    isRicetta: false,
                    ricettaId: null,
                    ingredienteDBId: null,
                    unitaDisponibili: []
                });
            };

            const eliminaPasto = (id) => {
                setPasti(pasti.filter(p => p.id !== id));
            };

            const calcolaMacroDaGrammi = (ricetta, grammi) => {
                const fattore = grammi / 100;
                return {
                    calorie: Math.round(parseFloat(ricetta.macro.calorie || 0) * fattore),
                    proteine: (parseFloat(ricetta.macro.proteine || 0) * fattore).toFixed(1),
                    carboidrati: (parseFloat(ricetta.macro.carboidrati || 0) * fattore).toFixed(1),
                    grassi: (parseFloat(ricetta.macro.grassi || 0) * fattore).toFixed(1)
                };
            };

            const usaRicetta = (ricetta) => {
                // Se la ricetta ha grammiPorzione definito, usa quello come default
                const grammiDefault = ricetta.grammiPorzione || '100';
                const macroCalcolati = ricetta.grammiPorzione
                    ? calcolaMacroDaGrammi(ricetta, parseFloat(ricetta.grammiPorzione))
                    : ricetta.macro;

                setNuovoPasto({
                    ...nuovoPasto,
                    nome: ricetta.nome,
                    quantita: grammiDefault,
                    unita: 'g',
                    macro: macroCalcolati,
                    isRicetta: true,
                    ricettaId: ricetta.id
                });
                setActiveTab('tracking');
            };

            const selezionaRicettaTracking = (ricettaId) => {
                if (!ricettaId) {
                    // Reset a inserimento manuale
                    setNuovoPasto({
                        ...nuovoPasto,
                        nome: '',
                        quantita: '',
                        unita: 'g',
                        macro: { calorie: '', proteine: '', carboidrati: '', grassi: '' },
                        isRicetta: false,
                        ricettaId: null
                    });
                    return;
                }

                const ricetta = ricette.find(r => r.id === parseInt(ricettaId));
                if (!ricetta) return;

                const grammiDefault = ricetta.grammiPorzione || '100';
                const macroCalcolati = ricetta.grammiPorzione
                    ? calcolaMacroDaGrammi(ricetta, parseFloat(ricetta.grammiPorzione))
                    : ricetta.macro;

                setNuovoPasto({
                    ...nuovoPasto,
                    nome: ricetta.nome,
                    quantita: grammiDefault,
                    unita: 'g',
                    macro: macroCalcolati,
                    isRicetta: true,
                    ricettaId: ricetta.id
                });
            };

            const aggiornaQuantitaRicetta = (quantita) => {
                if (!nuovoPasto.isRicetta || !nuovoPasto.ricettaId) {
                    setNuovoPasto({ ...nuovoPasto, quantita });
                    return;
                }

                const ricetta = ricette.find(r => r.id === nuovoPasto.ricettaId);
                if (!ricetta || !quantita) {
                    setNuovoPasto({ ...nuovoPasto, quantita });
                    return;
                }

                const macroCalcolati = calcolaMacroDaGrammi(ricetta, parseFloat(quantita));
                setNuovoPasto({
                    ...nuovoPasto,
                    quantita,
                    macro: macroCalcolati
                });
            };

            const totaliGiornalieri = (data) => {
                const pastiDelGiorno = pasti.filter(p => p.data === data);
                return pastiDelGiorno.reduce((acc, p) => ({
                    calorie: acc.calorie + (parseFloat(p.macro.calorie) || 0),
                    proteine: acc.proteine + (parseFloat(p.macro.proteine) || 0),
                    carboidrati: acc.carboidrati + (parseFloat(p.macro.carboidrati) || 0),
                    grassi: acc.grassi + (parseFloat(p.macro.grassi) || 0)
                }), { calorie: 0, proteine: 0, carboidrati: 0, grassi: 0 });
            };

            const esportaDati = () => {
                const dati = {
                    ricette,
                    ingredientiDB,
                    inventario,
                    listaSpesa,
                    pasti,
                    versione: '2.0',
                    dataEsportazione: new Date().toISOString()
                };
                const jsonString = JSON.stringify(dati, null, 2);

                // SEMPRE copia negli appunti (per WebStorm e altri browser embedded)
                navigator.clipboard.writeText(jsonString).catch(() => {
                    // Ignora errori clipboard silenziosamente
                });

                // Tenta anche il download standard
                try {
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `cucina-backup-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    // Ignora errori download silenziosamente
                    // I dati sono comunque negli appunti
                }
            };

            const processaImport = (jsonString, fonte) => {
                try {
                    const dati = JSON.parse(jsonString);

                    // Importa tutti i dati disponibili
                    if (dati.ricette) setRicette(dati.ricette);
                    if (dati.ingredientiDB) setIngredientiDB(dati.ingredientiDB);
                    if (dati.inventario) setInventario(dati.inventario);
                    if (dati.listaSpesa) setListaSpesa(dati.listaSpesa);
                    if (dati.pasti) setPasti(dati.pasti);

                    // Messaggio di successo con info sulla versione
                    let messaggio = `Dati importati con successo da ${fonte}! ‚úÖ\n\n`;
                    messaggio += `üìñ ${dati.ricette?.length || 0} ricette\n`;
                    messaggio += `ü•ï ${dati.ingredientiDB?.length || 0} ingredienti DB\n`;
                    messaggio += `üì¶ ${dati.inventario?.length || 0} item inventario\n`;
                    messaggio += `üõí ${dati.listaSpesa?.length || 0} item spesa\n`;
                    messaggio += `üìä ${dati.pasti?.length || 0} pasti tracciati`;

                    if (dati.versione) {
                        messaggio += `\n\nVersione backup: ${dati.versione}`;
                    }
                    if (dati.dataEsportazione) {
                        const data = new Date(dati.dataEsportazione);
                        messaggio += `\nData esportazione: ${data.toLocaleDateString('it-IT')} ${data.toLocaleTimeString('it-IT')}`;
                    }

                    alert(messaggio);
                    return true;
                } catch (error) {
                    return false;
                }
            };

            const importaDaFile = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const successo = processaImport(event.target.result, 'file');
                    if (!successo) {
                        alert('‚ùå Errore nell\'importazione del file.\n\nAssicurati che sia un file JSON valido esportato dall\'app.');
                    }
                    // Reset del file input
                    e.target.value = '';
                };
                reader.readAsText(file);
            };

            const importaDaClipboard = async () => {
                try {
                    const clipboardText = await navigator.clipboard.readText();
                    if (clipboardText && clipboardText.trim().startsWith('{')) {
                        const successo = processaImport(clipboardText, 'appunti');
                        if (!successo) {
                            alert('‚ùå Errore nell\'importazione.\n\nGli appunti non contengono un backup valido.');
                        }
                    } else {
                        alert('‚ö†Ô∏è Gli appunti non contengono un JSON valido.\n\nCopia prima il contenuto del backup esportato.');
                    }
                } catch (error) {
                    alert('‚ùå Impossibile leggere dagli appunti.\n\nSu mobile, usa l\'importazione da file oppure concedi i permessi clipboard.');
                }
            };

            return (
                <div className={`min-h-screen transition-colors duration-300 p-2 sm:p-4 ${
                    darkMode
                        ? 'bg-gradient-to-br from-gray-900 to-gray-800'
                        : 'bg-gradient-to-br from-orange-50 to-red-50'
                }`}>
                    <div className="max-w-6xl mx-auto">
                        <div className={`rounded-lg shadow-lg p-3 sm:p-6 mb-4 sm:mb-6 transition-colors duration-300 ${
                            darkMode ? 'bg-gray-800' : 'bg-white'
                        }`}>
                            <div className="flex flex-col gap-3">
                                <div className="flex justify-between items-center">
                                    <h1 className={`text-2xl sm:text-3xl font-bold text-center sm:text-left transition-colors ${
                                        darkMode ? 'text-orange-400' : 'text-orange-600'
                                    }`}>üç≥ Gestionale Cucina</h1>
                                    <button
                                        onClick={() => setDarkMode(!darkMode)}
                                        className={`p-3 rounded-lg transition-all min-w-[44px] min-h-[44px] ${
                                            darkMode
                                                ? 'bg-gray-700 text-yellow-300 hover:bg-gray-600'
                                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                        title={darkMode ? 'Tema chiaro' : 'Tema scuro'}
                                    >
                                        {darkMode ? <Sun /> : <Moon />}
                                    </button>
                                </div>
                                <div className="flex flex-wrap gap-2 justify-center sm:justify-start">
                                    <button
                                        onClick={ricettaRandom}
                                        className="flex items-center gap-2 bg-purple-500 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-purple-600 transition text-sm sm:text-base min-h-[44px]"
                                    >
                                        <Dice3 />
                                        <span className="hidden xs:inline">Random</span>
                                    </button>
                                    <button
                                        onClick={esportaDati}
                                        className="flex items-center gap-2 bg-blue-500 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-blue-600 transition text-sm sm:text-base min-h-[44px]"
                                    >
                                        <Download />
                                        <span className="hidden xs:inline">Esporta</span>
                                    </button>
                                    <label className="flex items-center gap-2 bg-green-500 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-green-600 transition cursor-pointer text-sm sm:text-base min-h-[44px]">
                                        <Upload />
                                        <span className="hidden xs:inline">Da File</span>
                                        <input type="file" accept=".json" onChange={importaDaFile} className="hidden" />
                                    </label>
                                    <button
                                        onClick={importaDaClipboard}
                                        className="flex items-center gap-2 bg-teal-500 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-teal-600 transition text-sm sm:text-base min-h-[44px]"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                        </svg>
                                        <span className="hidden xs:inline">Da Appunti</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className={`rounded-lg shadow-lg mb-4 sm:mb-6 overflow-hidden transition-colors duration-300 ${
                            darkMode ? 'bg-gray-800' : 'bg-white'
                        }`}>
                            <div className={`flex overflow-x-auto tab-container border-b snap-x snap-mandatory ${
                                darkMode ? 'border-gray-700' : 'border-gray-200'
                            }`}>
                                {[
                                    { key: 'ricette', label: 'Ricette', icon: 'üìñ' },
                                    { key: 'ingredienti', label: 'Ingredienti', icon: 'ü•ï' },
                                    { key: 'inventario', label: 'Inventario', icon: 'üì¶' },
                                    { key: 'spesa', label: 'Spesa', icon: 'üõí' },
                                    { key: 'tracking', label: 'Tracking', icon: 'üìä' }
                                ].map(tab => (
                                    <button
                                        key={tab.key}
                                        onClick={() => setActiveTab(tab.key)}
                                        className={`px-3 sm:px-6 py-3 font-semibold whitespace-nowrap flex-shrink-0 min-h-[44px] transition-all snap-center flex flex-col sm:flex-row items-center gap-1 sm:gap-2 ${
                                            activeTab === tab.key
                                                ? darkMode
                                                    ? 'border-b-3 border-orange-400 text-orange-400 bg-gray-700'
                                                    : 'border-b-3 border-orange-500 text-orange-600 bg-orange-50'
                                                : darkMode
                                                    ? 'text-gray-400 hover:text-gray-200 hover:bg-gray-700'
                                                    : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'
                                        }`}
                                    >
                                        <span className="text-lg sm:text-base">{tab.icon}</span>
                                        <span className="text-xs sm:text-base">{tab.label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className={`rounded-lg shadow-lg p-3 sm:p-6 transition-colors duration-300 ${
                            darkMode ? 'bg-gray-800' : 'bg-white'
                        }`}>
                            {activeTab === 'ricette' && (
                                <div>
                                    <h2 className={`text-xl sm:text-2xl font-bold mb-3 sm:mb-4 transition-colors ${
                                        darkMode ? 'text-gray-100' : 'text-gray-800'
                                    }`}>Le Mie Ricette</h2>

                                    <div className={`p-3 sm:p-4 rounded-lg mb-4 sm:mb-6 transition-colors ${
                                        darkMode ? 'bg-gray-700' : 'bg-orange-50'
                                    }`}>
                                        <div className="flex justify-between items-center mb-3">
                                            <h3 className={`font-semibold text-sm sm:text-base ${textClass}`}>
                                                {editingRecipeId ? 'Modifica Ricetta' : 'Aggiungi Ricetta'}
                                            </h3>
                                            {editingRecipeId && (
                                                <button
                                                    onClick={annullaModificaRicetta}
                                                    className="text-red-600 hover:text-red-700 text-sm"
                                                >
                                                    Annulla
                                                </button>
                                            )}
                                        </div>
                                        <input
                                            type="text"
                                            placeholder="Nome ricetta"
                                            value={nuovaRicetta.nome}
                                            onChange={(e) => setNuovaRicetta({ ...nuovaRicetta, nome: e.target.value })}
                                            className={inputClass('w-full p-3 border rounded mb-3 text-base')}
                                        />

                                        <div className="mb-3">
                                            <label className={`font-semibold block mb-2 text-sm sm:text-base ${textClass}`}>Ingredienti:</label>
                                            {nuovaRicetta.ingredienti.map((ing, idx) => (
                                                <div key={idx} className={`flex flex-col gap-2 mb-3 p-2 rounded ${bgAccent}`}>
                                                    <select
                                                        value=""
                                                        onChange={(e) => {
                                                            if (e.target.value) {
                                                                const ingDB = ingredientiDB.find(i => i.id === parseInt(e.target.value));
                                                                if (ingDB) {
                                                                    const nuoviIng = [...nuovaRicetta.ingredienti];
                                                                    nuoviIng[idx] = {
                                                                        nome: ingDB.nome,
                                                                        quantita: '100',
                                                                        unita: ingDB.unitaDefault
                                                                    };
                                                                    setNuovaRicetta({ ...nuovaRicetta, ingredienti: nuoviIng });
                                                                }
                                                            }
                                                        }}
                                                        className={inputClass('w-full p-2 border rounded text-sm')}
                                                    >
                                                        <option value="">üîç Cerca nel database o inserisci manualmente sotto</option>
                                                        {ingredientiDB.map(ingDB => (
                                                            <option key={ingDB.id} value={ingDB.id}>{ingDB.nome}</option>
                                                        ))}
                                                    </select>
                                                    <div className="flex flex-col sm:flex-row gap-2">
                                                        <input
                                                            type="text"
                                                            placeholder="Nome ingrediente"
                                                            value={ing.nome}
                                                            onChange={(e) => {
                                                                const nuoviIng = [...nuovaRicetta.ingredienti];
                                                                nuoviIng[idx].nome = e.target.value;
                                                                setNuovaRicetta({ ...nuovaRicetta, ingredienti: nuoviIng });
                                                            }}
                                                            className={inputClass('flex-1 p-3 border rounded text-base')}
                                                        />
                                                        <div className="flex gap-2">
                                                        <input
                                                            type="number"
                                                            placeholder="Qt√†"
                                                            value={ing.quantita}
                                                            onChange={(e) => {
                                                                const nuoviIng = [...nuovaRicetta.ingredienti];
                                                                nuoviIng[idx].quantita = e.target.value;
                                                                setNuovaRicetta({ ...nuovaRicetta, ingredienti: nuoviIng });
                                                            }}
                                                            className={inputClass('w-24 p-3 border rounded text-base')}
                                                        />
                                                        <select
                                                            value={ing.unita}
                                                            onChange={(e) => {
                                                                const nuoviIng = [...nuovaRicetta.ingredienti];
                                                                nuoviIng[idx].unita = e.target.value;
                                                                setNuovaRicetta({ ...nuovaRicetta, ingredienti: nuoviIng });
                                                            }}
                                                            className={inputClass('flex-1 sm:w-32 p-3 border rounded text-base')}
                                                        >
                                                            {unitaMisura.map(u => <option key={u} value={u}>{u}</option>)}
                                                        </select>
                                                        {idx > 0 && (
                                                            <button
                                                                onClick={() => rimuoviIngredienteRicetta(idx)}
                                                                className="p-3 bg-red-500 text-white rounded hover:bg-red-600 min-w-[44px] min-h-[44px] flex items-center justify-center"
                                                            >
                                                                <X />
                                                            </button>
                                                        )}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                            <button
                                                onClick={aggiungiIngredienteRicetta}
                                                className="text-orange-600 hover:text-orange-700 text-sm sm:text-base py-2 min-h-[44px]"
                                            >
                                                + Aggiungi ingrediente
                                            </button>
                                        </div>

                                        <div className="flex gap-2 mb-3">
                                            <button
                                                onClick={copiaIngredientiJSON}
                                                className="flex-1 flex items-center justify-center gap-2 bg-indigo-500 text-white px-3 py-2 rounded-lg hover:bg-indigo-600 transition text-sm min-h-[44px]"
                                            >
                                                <Copy />
                                                <span className="hidden sm:inline">Copia Ingredienti per AI</span>
                                                <span className="sm:hidden">Copia per AI</span>
                                            </button>
                                        </div>

                                        <textarea
                                            placeholder="Istruzioni di preparazione..."
                                            value={nuovaRicetta.istruzioni}
                                            onChange={(e) => setNuovaRicetta({ ...nuovaRicetta, istruzioni: e.target.value })}
                                            className={inputClass('w-full p-3 border rounded mb-3 h-24 text-base')}
                                        />

                                        <div className="grid grid-cols-2 gap-2 mb-3">
                                            <div>
                                                <label className={`text-xs block mb-1 ${textSecondary}`}>Grammi totali piatto finito</label>
                                                <input
                                                    type="number"
                                                    placeholder="es. 400"
                                                    value={nuovaRicetta.grammiTotali}
                                                    onChange={(e) => setNuovaRicetta({ ...nuovaRicetta, grammiTotali: e.target.value })}
                                                    className={inputClass('w-full p-3 border rounded text-base')}
                                                />
                                            </div>
                                            <div>
                                                <label className={`text-xs block mb-1 ${textSecondary}`}>Grammi per 1 porzione</label>
                                                <input
                                                    type="number"
                                                    placeholder="es. 200"
                                                    value={nuovaRicetta.grammiPorzione}
                                                    onChange={(e) => setNuovaRicetta({ ...nuovaRicetta, grammiPorzione: e.target.value })}
                                                    className={inputClass('w-full p-3 border rounded text-base')}
                                                />
                                            </div>
                                        </div>

                                        <div className="bg-blue-50 p-3 rounded mb-3 text-xs text-gray-700">
                                            <strong>‚ÑπÔ∏è Info:</strong> I macro inseriti sotto devono essere per <strong>100g di piatto finito</strong>. Usa il bottone "Copia per AI" per farli calcolare automaticamente da Claude.
                                        </div>

                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3">
                                            <input
                                                type="number"
                                                placeholder="Calorie"
                                                value={nuovaRicetta.macro.calorie}
                                                onChange={(e) => setNuovaRicetta({
                                                    ...nuovaRicetta,
                                                    macro: { ...nuovaRicetta.macro, calorie: e.target.value }
                                                })}
                                                className={inputClass('p-3 border rounded text-base')}
                                            />
                                            <input
                                                type="number"
                                                placeholder="Proteine (g)"
                                                value={nuovaRicetta.macro.proteine}
                                                onChange={(e) => setNuovaRicetta({
                                                    ...nuovaRicetta,
                                                    macro: { ...nuovaRicetta.macro, proteine: e.target.value }
                                                })}
                                                className={inputClass('p-3 border rounded text-base')}
                                            />
                                            <input
                                                type="number"
                                                placeholder="Carbo (g)"
                                                value={nuovaRicetta.macro.carboidrati}
                                                onChange={(e) => setNuovaRicetta({
                                                    ...nuovaRicetta,
                                                    macro: { ...nuovaRicetta.macro, carboidrati: e.target.value }
                                                })}
                                                className={inputClass('p-3 border rounded text-base')}
                                            />
                                            <input
                                                type="number"
                                                placeholder="Grassi (g)"
                                                value={nuovaRicetta.macro.grassi}
                                                onChange={(e) => setNuovaRicetta({
                                                    ...nuovaRicetta,
                                                    macro: { ...nuovaRicetta.macro, grassi: e.target.value }
                                                })}
                                                className={inputClass('p-3 border rounded text-base')}
                                            />
                                        </div>

                                        <div className="flex gap-2 mb-3">
                                            <button
                                                onClick={incollaMacroJSON}
                                                className="flex-1 flex items-center justify-center gap-2 bg-teal-500 text-white px-3 py-2 rounded-lg hover:bg-teal-600 transition text-sm min-h-[44px]"
                                            >
                                                <Clipboard />
                                                <span className="hidden sm:inline">Incolla Macro da AI</span>
                                                <span className="sm:hidden">Incolla da AI</span>
                                            </button>
                                        </div>

                                        <button
                                            onClick={aggiungiRicetta}
                                            className="w-full bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600 transition min-h-[44px] text-base font-semibold"
                                        >
                                            {editingRecipeId ? 'Salva Modifiche' : 'Aggiungi Ricetta'}
                                        </button>
                                    </div>

                                    <div className="space-y-3 sm:space-y-4">
                                        {ricette.map(ricetta => (
                                            <div key={ricetta.id} className={`border rounded-lg p-3 sm:p-4 hover:shadow-md transition ${cardClass}`}>
                                                <div className="flex flex-col sm:flex-row justify-between sm:items-start gap-2 mb-2">
                                                    <h3 className={`text-lg sm:text-xl font-semibold ${textClass}`}>{ricetta.nome}</h3>
                                                    <div className="flex gap-2 flex-shrink-0">
                                                        <button
                                                            onClick={() => modificaRicetta(ricetta)}
                                                            className="text-amber-600 hover:text-amber-700 p-2 min-w-[44px] min-h-[44px] flex items-center justify-center"
                                                            title="Modifica ricetta"
                                                        >
                                                            <Edit2 />
                                                        </button>
                                                        <button
                                                            onClick={() => usaRicetta(ricetta)}
                                                            className="text-green-600 hover:text-green-700 p-2 min-w-[44px] min-h-[44px] flex items-center justify-center"
                                                            title="Usa per tracking"
                                                        >
                                                            <Plus />
                                                        </button>
                                                        <button
                                                            onClick={() => generaListaSpesaDaRicetta(ricetta)}
                                                            className="text-blue-600 hover:text-blue-700 p-2 min-w-[44px] min-h-[44px] flex items-center justify-center"
                                                            title="Aggiungi a spesa"
                                                        >
                                                            <ShoppingCart />
                                                        </button>
                                                        <button
                                                            onClick={() => eliminaRicetta(ricetta.id)}
                                                            className="text-red-600 hover:text-red-700 p-2 min-w-[44px] min-h-[44px] flex items-center justify-center"
                                                        >
                                                            <Trash2 />
                                                        </button>
                                                    </div>
                                                </div>

                                                <div className="mb-2">
                                                    <p className={`font-semibold text-sm ${textSecondary}`}>Ingredienti:</p>
                                                    <ul className={`text-sm ${textSecondary}`}>
                                                        {ricetta.ingredienti.map((ing, idx) => (
                                                            <li key={idx}>‚Ä¢ {ing.nome}: {ing.quantita} {ing.unita}</li>
                                                        ))}
                                                    </ul>
                                                </div>

                                                {ricetta.istruzioni && (
                                                    <p className={`text-sm mb-2 ${textSecondary}`}>{ricetta.istruzioni}</p>
                                                )}

                                                <div className="mb-2">
                                                    <p className="text-xs text-gray-500 mb-1">Macro per 100g:</p>
                                                    <div className="flex flex-wrap gap-2 text-sm">
                                                        <span className="bg-red-100 text-red-700 px-2 py-1 rounded">
                                                            {ricetta.macro.calorie} kcal
                                                        </span>
                                                        <span className="bg-blue-100 text-blue-700 px-2 py-1 rounded">
                                                            P: {ricetta.macro.proteine}g
                                                        </span>
                                                        <span className="bg-yellow-100 text-yellow-700 px-2 py-1 rounded">
                                                            C: {ricetta.macro.carboidrati}g
                                                        </span>
                                                        <span className="bg-green-100 text-green-700 px-2 py-1 rounded">
                                                            G: {ricetta.macro.grassi}g
                                                        </span>
                                                    </div>
                                                </div>

                                                {ricetta.grammiPorzione && (
                                                    <div>
                                                        <p className="text-xs text-gray-500 mb-1">Macro per porzione ({ricetta.grammiPorzione}g):</p>
                                                        <div className="flex flex-wrap gap-2 text-sm">
                                                            {(() => {
                                                                const macroPorzione = calcolaMacroDaGrammi(ricetta, parseFloat(ricetta.grammiPorzione));
                                                                return (
                                                                    <>
                                                                        <span className="bg-red-50 text-red-600 px-2 py-1 rounded border border-red-200">
                                                                            {macroPorzione.calorie} kcal
                                                                        </span>
                                                                        <span className="bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-200">
                                                                            P: {macroPorzione.proteine}g
                                                                        </span>
                                                                        <span className="bg-yellow-50 text-yellow-600 px-2 py-1 rounded border border-yellow-200">
                                                                            C: {macroPorzione.carboidrati}g
                                                                        </span>
                                                                        <span className="bg-green-50 text-green-600 px-2 py-1 rounded border border-green-200">
                                                                            G: {macroPorzione.grassi}g
                                                                        </span>
                                                                    </>
                                                                );
                                                            })()}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'ingredienti' && (
                                <div>
                                    <h2 className={`text-xl sm:text-2xl font-bold mb-3 sm:mb-4 ${textClass}`}>ü•ï Database Ingredienti</h2>

                                    <div className={`p-3 sm:p-4 rounded-lg mb-4 sm:mb-6 ${bgAccent}`}>
                                        <div className="flex justify-between items-center mb-3">
                                            <h3 className={`font-semibold text-sm sm:text-base ${textClass}`}>
                                                {editingIngredienteId ? 'Modifica Ingrediente' : 'Aggiungi Ingrediente'}
                                            </h3>
                                            {editingIngredienteId && (
                                                <button
                                                    onClick={annullaModificaIngrediente}
                                                    className="text-red-600 hover:text-red-700 text-sm"
                                                >
                                                    Annulla
                                                </button>
                                            )}
                                        </div>

                                        {/* Nome e Categoria */}
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                            <div>
                                                <label className={`text-xs block mb-1 ${textSecondary}`}>Nome ingrediente *</label>
                                                <input
                                                    type="text"
                                                    placeholder="es. Gallette di Riso"
                                                    value={nuovoIngredienteDB.nome}
                                                    onChange={(e) => setNuovoIngredienteDB({ ...nuovoIngredienteDB, nome: e.target.value })}
                                                    className={inputClass('w-full p-3 border rounded text-base')}
                                                />
                                            </div>
                                            <div>
                                                <label className={`text-xs block mb-1 ${textSecondary}`}>Categoria</label>
                                                <select
                                                    value={nuovoIngredienteDB.categoria}
                                                    onChange={(e) => setNuovoIngredienteDB({ ...nuovoIngredienteDB, categoria: e.target.value })}
                                                    className={inputClass('w-full p-3 border rounded text-base')}
                                                >
                                                    {categorie.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                                </select>
                                            </div>
                                        </div>

                                        {/* Unit√† Principale */}
                                        <div className="mb-3">
                                            <label className={`text-xs block mb-1 ${textSecondary}`}>Unit√† di misura principale *</label>
                                            <select
                                                value={nuovoIngredienteDB.unitaPrincipale}
                                                onChange={(e) => setNuovoIngredienteDB({
                                                    ...nuovoIngredienteDB,
                                                    unitaPrincipale: e.target.value,
                                                    unitaDefault: e.target.value
                                                })}
                                                className={inputClass('w-full p-3 border rounded text-base')}
                                            >
                                                <option value="g">Grammi (g)</option>
                                                <option value="ml">Millilitri (ml)</option>
                                            </select>
                                            <p className={`text-xs mt-1 ${textSecondary}`}>
                                                I macro devono essere per <strong>100{nuovoIngredienteDB.unitaPrincipale}</strong>
                                            </p>
                                        </div>

                                        {/* Macro */}
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3">
                                            <input
                                                type="number"
                                                placeholder="Calorie"
                                                value={nuovoIngredienteDB.macro.calorie}
                                                onChange={(e) => setNuovoIngredienteDB({
                                                    ...nuovoIngredienteDB,
                                                    macro: { ...nuovoIngredienteDB.macro, calorie: e.target.value }
                                                })}
                                                className={inputClass('p-3 border rounded text-base')}
                                            />
                                            <input
                                                type="number"
                                                placeholder="Proteine (g)"
                                                value={nuovoIngredienteDB.macro.proteine}
                                                onChange={(e) => setNuovoIngredienteDB({
                                                    ...nuovoIngredienteDB,
                                                    macro: { ...nuovoIngredienteDB.macro, proteine: e.target.value }
                                                })}
                                                className={inputClass('p-3 border rounded text-base')}
                                            />
                                            <input
                                                type="number"
                                                placeholder="Carbo (g)"
                                                value={nuovoIngredienteDB.macro.carboidrati}
                                                onChange={(e) => setNuovoIngredienteDB({
                                                    ...nuovoIngredienteDB,
                                                    macro: { ...nuovoIngredienteDB.macro, carboidrati: e.target.value }
                                                })}
                                                className={inputClass('p-3 border rounded text-base')}
                                            />
                                            <input
                                                type="number"
                                                placeholder="Grassi (g)"
                                                value={nuovoIngredienteDB.macro.grassi}
                                                onChange={(e) => setNuovoIngredienteDB({
                                                    ...nuovoIngredienteDB,
                                                    macro: { ...nuovoIngredienteDB.macro, grassi: e.target.value }
                                                })}
                                                className={inputClass('p-3 border rounded text-base')}
                                            />
                                        </div>

                                        {/* Conversioni Unit√† */}
                                        <div className="mb-3">
                                            <div className="flex justify-between items-center mb-2">
                                                <label className={`text-xs font-semibold ${textSecondary}`}>Conversioni Unit√† (opzionale)</label>
                                                <button
                                                    onClick={aggiungiConversione}
                                                    className="text-xs text-teal-600 hover:text-teal-700"
                                                >
                                                    + Aggiungi conversione
                                                </button>
                                            </div>
                                            {nuovoIngredienteDB.conversioniUnita.map((conv, idx) => {
                                                // Calcola macro convertiti
                                                const fattore = parseFloat(conv.fattore) || 0;
                                                const macroConvertiti = fattore > 0 ? {
                                                    calorie: Math.round((parseFloat(nuovoIngredienteDB.macro.calorie) || 0) * fattore / 100),
                                                    proteine: ((parseFloat(nuovoIngredienteDB.macro.proteine) || 0) * fattore / 100).toFixed(1),
                                                    carboidrati: ((parseFloat(nuovoIngredienteDB.macro.carboidrati) || 0) * fattore / 100).toFixed(1),
                                                    grassi: ((parseFloat(nuovoIngredienteDB.macro.grassi) || 0) * fattore / 100).toFixed(1)
                                                } : null;

                                                return (
                                                    <div key={idx} className={`mb-3 p-3 rounded border ${darkMode ? 'bg-gray-600 border-gray-500' : 'bg-gray-100 border-gray-300'}`}>
                                                        <div className="flex gap-2 mb-2">
                                                            <select
                                                                value={conv.unita}
                                                                onChange={(e) => aggiornaConversione(idx, 'unita', e.target.value)}
                                                                className={inputClass('flex-1 p-2 border rounded text-sm')}
                                                            >
                                                                <option value="">Seleziona unit√†</option>
                                                                {unitaMisura.map(u => <option key={u} value={u}>{u}</option>)}
                                                            </select>
                                                            <div className="flex items-center gap-1">
                                                                <input
                                                                    type="number"
                                                                    placeholder="Fattore"
                                                                    value={conv.fattore}
                                                                    onChange={(e) => aggiornaConversione(idx, 'fattore', e.target.value)}
                                                                    className={inputClass('w-20 p-2 border rounded text-sm')}
                                                                />
                                                                <span className={`text-xs whitespace-nowrap ${textSecondary}`}>
                                                                    {nuovoIngredienteDB.unitaPrincipale}
                                                                </span>
                                                            </div>
                                                            <button
                                                                onClick={() => rimuoviConversione(idx)}
                                                                className="text-red-600 hover:text-red-700 p-2 flex-shrink-0"
                                                                title="Rimuovi conversione"
                                                            >
                                                                <X />
                                                            </button>
                                                        </div>

                                                        {/* Macro convertiti */}
                                                        {conv.unita && macroConvertiti && (
                                                            <div className={`pt-2 border-t ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                                                                <p className={`text-xs mb-1 ${textSecondary}`}>
                                                                    Macro per 1 {conv.unita}:
                                                                </p>
                                                                <div className="grid grid-cols-4 gap-1">
                                                                    <div className={`text-center p-1 rounded text-xs ${darkMode ? 'bg-gray-700' : 'bg-white'}`}>
                                                                        <div className="text-red-600 font-bold">{macroConvertiti.calorie}</div>
                                                                        <div className={textSecondary}>kcal</div>
                                                                    </div>
                                                                    <div className={`text-center p-1 rounded text-xs ${darkMode ? 'bg-gray-700' : 'bg-white'}`}>
                                                                        <div className="text-blue-600 font-bold">{macroConvertiti.proteine}g</div>
                                                                        <div className={textSecondary}>P</div>
                                                                    </div>
                                                                    <div className={`text-center p-1 rounded text-xs ${darkMode ? 'bg-gray-700' : 'bg-white'}`}>
                                                                        <div className="text-yellow-600 font-bold">{macroConvertiti.carboidrati}g</div>
                                                                        <div className={textSecondary}>C</div>
                                                                    </div>
                                                                    <div className={`text-center p-1 rounded text-xs ${darkMode ? 'bg-gray-700' : 'bg-white'}`}>
                                                                        <div className="text-green-600 font-bold">{macroConvertiti.grassi}g</div>
                                                                        <div className={textSecondary}>G</div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                            {nuovoIngredienteDB.conversioniUnita.length > 0 && (
                                                <p className={`text-xs mt-1 ${textSecondary}`}>
                                                    Es: 1 pz = 9g significa che 1 pezzo pesa 9 {nuovoIngredienteDB.unitaPrincipale}
                                                </p>
                                            )}
                                        </div>

                                        {/* Unit√† Default */}
                                        {nuovoIngredienteDB.conversioniUnita.length > 0 && (
                                            <div className="mb-3">
                                                <label className={`text-xs block mb-1 ${textSecondary}`}>Unit√† predefinita da mostrare</label>
                                                <select
                                                    value={nuovoIngredienteDB.unitaDefault}
                                                    onChange={(e) => setNuovoIngredienteDB({ ...nuovoIngredienteDB, unitaDefault: e.target.value })}
                                                    className={inputClass('w-full p-3 border rounded text-base')}
                                                >
                                                    <option value={nuovoIngredienteDB.unitaPrincipale}>{nuovoIngredienteDB.unitaPrincipale}</option>
                                                    {nuovoIngredienteDB.conversioniUnita
                                                        .filter(conv => conv.unita && conv.fattore)
                                                        .map((conv, idx) => (
                                                            <option key={idx} value={conv.unita}>{conv.unita}</option>
                                                        ))
                                                    }
                                                </select>
                                            </div>
                                        )}

                                        <button
                                            onClick={aggiungiIngredienteDB}
                                            className="w-full bg-teal-500 text-white py-3 rounded-lg hover:bg-teal-600 transition min-h-[44px] text-base font-semibold"
                                        >
                                            {editingIngredienteId ? 'Salva Modifiche' : 'Aggiungi al Database'}
                                        </button>
                                    </div>

                                    {/* Filtri e Ordinamento */}
                                    <div className="flex flex-col sm:flex-row gap-2 mb-4">
                                        <select
                                            value={filtroCategoria}
                                            onChange={(e) => setFiltroCategoria(e.target.value)}
                                            className={inputClass('flex-1 p-3 border rounded text-base')}
                                        >
                                            <option value="Tutte">üìÇ Tutte le categorie</option>
                                            {categorie.map(cat => (
                                                <option key={cat} value={cat}>{cat}</option>
                                            ))}
                                        </select>
                                        <select
                                            value={ordinamento}
                                            onChange={(e) => setOrdinamento(e.target.value)}
                                            className={inputClass('flex-1 p-3 border rounded text-base')}
                                        >
                                            <option value="nome">üî§ Ordina per nome</option>
                                            <option value="categoria">üìÅ Ordina per categoria</option>
                                            <option value="calorie">üî• Ordina per calorie</option>
                                            <option value="proteine">üí™ Ordina per proteine</option>
                                        </select>
                                    </div>

                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                                        {getIngredientiFiltrati().map(ing => {
                                            // Calcola i macro in base all'unit√† predefinita
                                            const unitaDefault = ing.unitaDefault || ing.unitaPrincipale || 'g';
                                            const unitaPrincipale = ing.unitaPrincipale || 'g';

                                            let macroMostrati = ing.macro;
                                            let testoDose = `100${unitaPrincipale}`;

                                            // Se l'unit√† default √® diversa dalla principale, cerca la conversione
                                            if (unitaDefault !== unitaPrincipale && ing.conversioniUnita) {
                                                const conversione = ing.conversioniUnita.find(c => c.unita === unitaDefault);
                                                if (conversione && conversione.fattore) {
                                                    const fattore = parseFloat(conversione.fattore);
                                                    macroMostrati = {
                                                        calorie: Math.round((parseFloat(ing.macro.calorie) || 0) * fattore / 100),
                                                        proteine: ((parseFloat(ing.macro.proteine) || 0) * fattore / 100).toFixed(1),
                                                        carboidrati: ((parseFloat(ing.macro.carboidrati) || 0) * fattore / 100).toFixed(1),
                                                        grassi: ((parseFloat(ing.macro.grassi) || 0) * fattore / 100).toFixed(1)
                                                    };
                                                    testoDose = `1${unitaDefault}`;
                                                }
                                            }

                                            return (
                                                <div key={ing.id} className={`border-2 border-teal-200 rounded-lg p-3 sm:p-4 hover:shadow-md transition ${bgAccent}`}>
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex-1">
                                                            <h3 className={`font-bold text-base ${textClass}`}>{ing.nome}</h3>
                                                            <div className="flex flex-wrap gap-1 mt-1">
                                                                <span className={`text-xs px-2 py-0.5 rounded ${darkMode ? 'bg-teal-900 text-teal-200' : 'bg-teal-100 text-teal-700'}`}>
                                                                    {ing.categoria || 'Altro'}
                                                                </span>
                                                                <span className={`text-xs px-2 py-0.5 rounded ${darkMode ? 'bg-gray-600 text-gray-200' : 'bg-gray-200 text-gray-700'}`}>
                                                                    {unitaDefault}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <div className="flex gap-1">
                                                            <button
                                                                onClick={() => modificaIngrediente(ing)}
                                                                className="text-amber-600 hover:text-amber-700 p-2 min-w-[40px] min-h-[40px] flex items-center justify-center"
                                                                title="Modifica"
                                                            >
                                                                <Edit2 />
                                                            </button>
                                                            <button
                                                                onClick={() => eliminaIngredienteDB(ing.id)}
                                                                className="text-red-600 hover:text-red-700 p-2 min-w-[40px] min-h-[40px] flex items-center justify-center"
                                                                title="Elimina"
                                                            >
                                                                <Trash2 />
                                                            </button>
                                                        </div>
                                                    </div>

                                                    {/* Macro per unit√† default */}
                                                    <div className="mb-2">
                                                        <p className={`text-xs ${textSecondary} mb-1`}>
                                                            Per {testoDose}:
                                                        </p>
                                                        <div className="flex flex-wrap gap-1 text-xs">
                                                            <span className="bg-red-100 text-red-700 px-2 py-1 rounded">
                                                                {macroMostrati.calorie} kcal
                                                            </span>
                                                            <span className="bg-blue-100 text-blue-700 px-2 py-1 rounded">
                                                                P: {macroMostrati.proteine}g
                                                            </span>
                                                            <span className="bg-yellow-100 text-yellow-700 px-2 py-1 rounded">
                                                                C: {macroMostrati.carboidrati}g
                                                            </span>
                                                            <span className="bg-green-100 text-green-700 px-2 py-1 rounded">
                                                                G: {macroMostrati.grassi}g
                                                            </span>
                                                        </div>
                                                    </div>

                                                    {/* Conversioni */}
                                                    {ing.conversioniUnita && ing.conversioniUnita.length > 0 && (
                                                        <div className="pt-2 border-t border-teal-200">
                                                            <p className={`text-xs ${textSecondary} mb-1`}>Conversioni:</p>
                                                            <div className="flex flex-wrap gap-1">
                                                                {ing.conversioniUnita
                                                                    .filter(conv => conv.unita && conv.fattore)
                                                                    .map((conv, idx) => (
                                                                        <span key={idx} className={`text-xs px-2 py-0.5 rounded ${darkMode ? 'bg-purple-900 text-purple-200' : 'bg-purple-100 text-purple-700'}`}>
                                                                            1 {conv.unita} = {conv.fattore}{unitaPrincipale}
                                                                        </span>
                                                                    ))
                                                                }
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>

                                    {getIngredientiFiltrati().length === 0 && (
                                        <div className={`text-center py-8 ${textSecondary}`}>
                                            <p>Nessun ingrediente trovato con i filtri selezionati.</p>
                                        </div>
                                    )}
                                </div>
                            )}

                            {activeTab === 'inventario' && (
                                <div>
                                    <h2 className={`text-xl sm:text-2xl font-bold mb-3 sm:mb-4 ${textClass}`}>Inventario Ingredienti</h2>

                                    <div className={`p-3 sm:p-4 rounded-lg mb-4 sm:mb-6 flex flex-col gap-2 ${bgAccent}`}>
                                        <select
                                            value=""
                                            onChange={(e) => {
                                                if (e.target.value) {
                                                    const ingDB = ingredientiDB.find(i => i.id === parseInt(e.target.value));
                                                    if (ingDB) {
                                                        setNuovoItem({
                                                            nome: ingDB.nome,
                                                            quantita: '100',
                                                            unita: ingDB.unitaDefault
                                                        });
                                                    }
                                                }
                                            }}
                                            className={inputClass('w-full p-3 border rounded text-base')}
                                        >
                                            <option value="">üîç Cerca nel database o inserisci sotto</option>
                                            {ingredientiDB.map(ingDB => (
                                                <option key={ingDB.id} value={ingDB.id}>{ingDB.nome}</option>
                                            ))}
                                        </select>
                                        <input
                                            type="text"
                                            placeholder="Nome ingrediente"
                                            value={nuovoItem.nome}
                                            onChange={(e) => setNuovoItem({ ...nuovoItem, nome: e.target.value })}
                                            className={inputClass('w-full p-3 border rounded text-base')}
                                        />
                                        <div className="flex gap-2">
                                            <input
                                                type="number"
                                                placeholder="Quantit√†"
                                                value={nuovoItem.quantita}
                                                onChange={(e) => setNuovoItem({ ...nuovoItem, quantita: e.target.value })}
                                                className={inputClass('flex-1 p-3 border rounded text-base')}
                                            />
                                            <select
                                                value={nuovoItem.unita}
                                                onChange={(e) => setNuovoItem({ ...nuovoItem, unita: e.target.value })}
                                                className={inputClass('flex-1 p-3 border rounded text-base')}
                                            >
                                                {unitaMisura.map(u => <option key={u} value={u}>{u}</option>)}
                                            </select>
                                        </div>
                                        <button
                                            onClick={aggiungiInventario}
                                            className="w-full bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition min-h-[44px] font-semibold"
                                        >
                                            Aggiungi
                                        </button>
                                    </div>

                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                                        {inventario.map(item => (
                                            <div key={item.id} className={`border rounded-lg p-3 sm:p-4 hover:shadow-md transition ${cardClass}`}>
                                                {editingId === item.id ? (
                                                    <div className="space-y-2">
                                                        <input
                                                            type="text"
                                                            value={item.nome}
                                                            onChange={(e) => modificaInventario(item.id, 'nome', e.target.value)}
                                                            className={inputClass('w-full p-3 border rounded text-base')}
                                                        />
                                                        <div className="flex gap-2">
                                                            <input
                                                                type="number"
                                                                value={item.quantita}
                                                                onChange={(e) => modificaInventario(item.id, 'quantita', e.target.value)}
                                                                className={inputClass('flex-1 p-3 border rounded text-base')}
                                                            />
                                                            <select
                                                                value={item.unita}
                                                                onChange={(e) => modificaInventario(item.id, 'unita', e.target.value)}
                                                                className={inputClass('flex-1 p-3 border rounded text-base')}
                                                            >
                                                                {unitaMisura.map(u => <option key={u} value={u}>{u}</option>)}
                                                            </select>
                                                        </div>
                                                        <button
                                                            onClick={() => setEditingId(null)}
                                                            className="w-full bg-green-500 text-white py-3 rounded hover:bg-green-600 flex items-center justify-center min-h-[44px] font-semibold"
                                                        >
                                                            <Check />
                                                        </button>
                                                    </div>
                                                ) : (
                                                    <div className="flex justify-between items-center">
                                                        <div>
                                                            <h3 className={`font-semibold ${textClass}`}>{item.nome}</h3>
                                                            <p className={`text-sm ${textSecondary}`}>{item.quantita} {item.unita}</p>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() => setEditingId(item.id)}
                                                                className="text-blue-600 hover:text-blue-700 p-2 min-w-[44px] min-h-[44px] flex items-center justify-center"
                                                            >
                                                                <Edit2 />
                                                            </button>
                                                            <button
                                                                onClick={() => eliminaInventario(item.id)}
                                                                className="text-red-600 hover:text-red-700 p-2 min-w-[44px] min-h-[44px] flex items-center justify-center"
                                                            >
                                                                <Trash2 />
                                                            </button>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'spesa' && (
                                <div>
                                    <h2 className={`text-xl sm:text-2xl font-bold mb-3 sm:mb-4 ${textClass}`}>Lista della Spesa</h2>

                                    <div className={`p-3 sm:p-4 rounded-lg mb-4 sm:mb-6 flex flex-col gap-2 ${bgAccent}`}>
                                        <select
                                            value=""
                                            onChange={(e) => {
                                                if (e.target.value) {
                                                    const ingDB = ingredientiDB.find(i => i.id === parseInt(e.target.value));
                                                    if (ingDB) {
                                                        setNuovoSpesa({
                                                            nome: ingDB.nome,
                                                            quantita: '100',
                                                            unita: ingDB.unitaDefault,
                                                            comprato: false
                                                        });
                                                    }
                                                }
                                            }}
                                            className={inputClass('w-full p-3 border rounded text-base')}
                                        >
                                            <option value="">üîç Cerca nel database o inserisci sotto</option>
                                            {ingredientiDB.map(ingDB => (
                                                <option key={ingDB.id} value={ingDB.id}>{ingDB.nome}</option>
                                            ))}
                                        </select>
                                        <input
                                            type="text"
                                            placeholder="Cosa comprare"
                                            value={nuovoSpesa.nome}
                                            onChange={(e) => setNuovoSpesa({ ...nuovoSpesa, nome: e.target.value })}
                                            className={inputClass('w-full p-3 border rounded text-base')}
                                        />
                                        <div className="flex gap-2">
                                            <input
                                                type="number"
                                                placeholder="Quantit√†"
                                                value={nuovoSpesa.quantita}
                                                onChange={(e) => setNuovoSpesa({ ...nuovoSpesa, quantita: e.target.value })}
                                                className={inputClass('flex-1 p-3 border rounded text-base')}
                                            />
                                            <select
                                                value={nuovoSpesa.unita}
                                                onChange={(e) => setNuovoSpesa({ ...nuovoSpesa, unita: e.target.value })}
                                                className={inputClass('flex-1 p-3 border rounded text-base')}
                                            >
                                                {unitaMisura.map(u => <option key={u} value={u}>{u}</option>)}
                                            </select>
                                        </div>
                                        <button
                                            onClick={aggiungiSpesa}
                                            className="w-full bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition min-h-[44px] font-semibold"
                                        >
                                            Aggiungi
                                        </button>
                                    </div>

                                    <div className="space-y-2">
                                        {listaSpesa.map(item => (
                                            <div
                                                key={item.id}
                                                className={`flex items-center justify-between p-3 sm:p-4 border rounded-lg hover:shadow-md transition ${
                                                    item.comprato ? `${bgAccent} opacity-60` : cardClass
                                                }`}
                                            >
                                                <div className="flex items-center gap-3 flex-1 min-h-[44px]">
                                                    <input
                                                        type="checkbox"
                                                        checked={item.comprato}
                                                        onChange={() => toggleComprato(item.id)}
                                                        className="w-6 h-6 cursor-pointer flex-shrink-0"
                                                    />
                                                    <div className={item.comprato ? `line-through ${textSecondary}` : ''}>
                                                        <span className={`font-semibold text-sm sm:text-base ${textClass}`}>{item.nome}</span>
                                                        {item.quantita && (
                                                            <span className={`text-xs sm:text-sm ml-2 ${textSecondary}`}>
                                                                ({item.quantita} {item.unita})
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                                <button
                                                    onClick={() => eliminaSpesa(item.id)}
                                                    className="text-red-600 hover:text-red-700 p-2 min-w-[44px] min-h-[44px] flex items-center justify-center flex-shrink-0"
                                                >
                                                    <Trash2 />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'tracking' && (
                                <div>
                                    <h2 className={`text-xl sm:text-2xl font-bold mb-3 sm:mb-4 ${textClass}`}>Tracking Pasti</h2>

                                    <div className={`p-3 sm:p-4 rounded-lg mb-4 sm:mb-6 ${bgAccent}`}>
                                        <h3 className={`font-semibold mb-3 text-sm sm:text-base ${textClass}`}>Registra Pasto</h3>

                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3 mb-3">
                                            <input
                                                type="date"
                                                value={nuovoPasto.data}
                                                onChange={(e) => setNuovoPasto({ ...nuovoPasto, data: e.target.value })}
                                                className={inputClass('p-3 border rounded text-base')}
                                            />
                                            <select
                                                value={nuovoPasto.tipoPasto}
                                                onChange={(e) => setNuovoPasto({ ...nuovoPasto, tipoPasto: e.target.value })}
                                                className={inputClass('p-3 border rounded text-base font-semibold')}
                                            >
                                                {tipiPasto.map(tipo => (
                                                    <option key={tipo} value={tipo}>{tipo}</option>
                                                ))}
                                            </select>
                                        </div>

                                        <div className="mb-3">
                                            <label className={`text-xs block mb-1 ${textSecondary}`}>üîç Cerca ricetta o ingrediente dal database</label>
                                            <select
                                                value={nuovoPasto.ricettaId || ''}
                                                onChange={(e) => selezionaRicettaTracking(e.target.value)}
                                                className={inputClass('w-full p-3 border rounded text-base mb-2')}
                                            >
                                                <option value="">-- Scegli ricetta completa --</option>
                                                {ricette.map(ricetta => (
                                                    <option key={ricetta.id} value={ricetta.id}>
                                                        üìñ {ricetta.nome} {ricetta.grammiPorzione ? `(${ricetta.grammiPorzione}g)` : '(100g)'}
                                                    </option>
                                                ))}
                                            </select>
                                            <select
                                                value=""
                                                onChange={(e) => selezionaIngredienteTracking(e.target.value)}
                                                className={inputClass('w-full p-3 border rounded text-base')}
                                            >
                                                <option value="">-- Scegli ingrediente singolo --</option>
                                                {ingredientiDB.map(ingDB => (
                                                    <option key={ingDB.id} value={ingDB.id}>
                                                        ü•ï {ingDB.nome} ({ingDB.unitaDefault || 'g'})
                                                    </option>
                                                ))}
                                            </select>
                                            <p className={`text-xs mt-1 ${textSecondary}`}>Oppure inserisci manualmente qui sotto ‚Üì</p>
                                        </div>

                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3 mb-3">
                                            <input
                                                type="text"
                                                placeholder="Nome alimento"
                                                value={nuovoPasto.nome}
                                                onChange={(e) => setNuovoPasto({ ...nuovoPasto, nome: e.target.value, ingredienteDBId: null, unitaDisponibili: [] })}
                                                className={inputClass('p-3 border rounded text-base')}
                                                disabled={nuovoPasto.isRicetta || nuovoPasto.ingredienteDBId}
                                            />
                                            <div className="flex gap-2">
                                                <input
                                                    type="number"
                                                    placeholder="Quantit√†"
                                                    value={nuovoPasto.quantita}
                                                    onChange={(e) => {
                                                        if (nuovoPasto.isRicetta) {
                                                            aggiornaQuantitaRicetta(e.target.value);
                                                        } else if (nuovoPasto.ingredienteDBId) {
                                                            aggiornaQuantitaIngrediente(e.target.value);
                                                        } else {
                                                            setNuovoPasto({ ...nuovoPasto, quantita: e.target.value });
                                                        }
                                                    }}
                                                    className={inputClass('flex-1 p-3 border rounded text-base')}
                                                />
                                                <select
                                                    value={nuovoPasto.unita}
                                                    onChange={(e) => {
                                                        if (nuovoPasto.ingredienteDBId) {
                                                            aggiornaUnitaIngrediente(e.target.value);
                                                        } else {
                                                            setNuovoPasto({ ...nuovoPasto, unita: e.target.value });
                                                        }
                                                    }}
                                                    className={inputClass('p-3 border rounded text-base')}
                                                    disabled={nuovoPasto.isRicetta}
                                                >
                                                    {nuovoPasto.ingredienteDBId && nuovoPasto.unitaDisponibili.length > 0 ? (
                                                        nuovoPasto.unitaDisponibili.map(u => (
                                                            <option key={u} value={u}>{u}</option>
                                                        ))
                                                    ) : (
                                                        <>
                                                            <option value="g">g</option>
                                                            <option value="kg">kg</option>
                                                            <option value="porzione">porzione</option>
                                                            {unitaMisura.map(u => <option key={u} value={u}>{u}</option>)}
                                                        </>
                                                    )}
                                                </select>
                                            </div>
                                        </div>

                                        {/* Preview macro calcolati automaticamente */}
                                        {(nuovoPasto.ingredienteDBId || nuovoPasto.isRicetta) && nuovoPasto.nome && nuovoPasto.quantita && (
                                            <div className={`mb-3 p-3 rounded border ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-blue-50 border-blue-200'}`}>
                                                <p className={`text-xs mb-2 ${textSecondary}`}>
                                                    üìä Macro calcolati per {nuovoPasto.quantita} {nuovoPasto.unita} di {nuovoPasto.nome}:
                                                </p>
                                                <div className="grid grid-cols-4 gap-2">
                                                    <div className={`text-center p-2 rounded ${darkMode ? 'bg-gray-600' : 'bg-white'}`}>
                                                        <div className="text-red-600 font-bold text-lg">{nuovoPasto.macro.calorie || 0}</div>
                                                        <div className={`text-xs ${textSecondary}`}>kcal</div>
                                                    </div>
                                                    <div className={`text-center p-2 rounded ${darkMode ? 'bg-gray-600' : 'bg-white'}`}>
                                                        <div className="text-blue-600 font-bold text-lg">{nuovoPasto.macro.proteine || 0}g</div>
                                                        <div className={`text-xs ${textSecondary}`}>Prot</div>
                                                    </div>
                                                    <div className={`text-center p-2 rounded ${darkMode ? 'bg-gray-600' : 'bg-white'}`}>
                                                        <div className="text-yellow-600 font-bold text-lg">{nuovoPasto.macro.carboidrati || 0}g</div>
                                                        <div className={`text-xs ${textSecondary}`}>Carb</div>
                                                    </div>
                                                    <div className={`text-center p-2 rounded ${darkMode ? 'bg-gray-600' : 'bg-white'}`}>
                                                        <div className="text-green-600 font-bold text-lg">{nuovoPasto.macro.grassi || 0}g</div>
                                                        <div className={`text-xs ${textSecondary}`}>Grass</div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3">
                                            <input
                                                type="number"
                                                placeholder="Calorie"
                                                value={nuovoPasto.macro.calorie}
                                                onChange={(e) => setNuovoPasto({
                                                    ...nuovoPasto,
                                                    macro: { ...nuovoPasto.macro, calorie: e.target.value }
                                                })}
                                                className={inputClass('p-3 border rounded text-base')}
                                                disabled={nuovoPasto.ingredienteDBId || nuovoPasto.isRicetta}
                                            />
                                            <input
                                                type="number"
                                                placeholder="Proteine (g)"
                                                value={nuovoPasto.macro.proteine}
                                                onChange={(e) => setNuovoPasto({
                                                    ...nuovoPasto,
                                                    macro: { ...nuovoPasto.macro, proteine: e.target.value }
                                                })}
                                                className={inputClass('p-3 border rounded text-base')}
                                                disabled={nuovoPasto.ingredienteDBId || nuovoPasto.isRicetta}
                                            />
                                            <input
                                                type="number"
                                                placeholder="Carbo (g)"
                                                value={nuovoPasto.macro.carboidrati}
                                                onChange={(e) => setNuovoPasto({
                                                    ...nuovoPasto,
                                                    macro: { ...nuovoPasto.macro, carboidrati: e.target.value }
                                                })}
                                                className={inputClass('p-3 border rounded text-base')}
                                                disabled={nuovoPasto.ingredienteDBId || nuovoPasto.isRicetta}
                                            />
                                            <input
                                                type="number"
                                                placeholder="Grassi (g)"
                                                value={nuovoPasto.macro.grassi}
                                                onChange={(e) => setNuovoPasto({
                                                    ...nuovoPasto,
                                                    macro: { ...nuovoPasto.macro, grassi: e.target.value }
                                                })}
                                                className={inputClass('p-3 border rounded text-base')}
                                                disabled={nuovoPasto.ingredienteDBId || nuovoPasto.isRicetta}
                                            />
                                        </div>

                                        <button
                                            onClick={aggiungiPasto}
                                            className="w-full bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 transition min-h-[44px] font-semibold"
                                        >
                                            Registra Pasto
                                        </button>
                                    </div>

                                    {pasti.length > 0 && (
                                        <div className={`mb-4 sm:mb-6 p-3 sm:p-4 rounded-lg ${darkMode ? 'bg-gradient-to-r from-purple-900 to-pink-900' : 'bg-gradient-to-r from-purple-100 to-pink-100'}`}>
                                            <h3 className={`font-semibold mb-2 text-sm sm:text-base ${textClass}`}>Totale di oggi:</h3>
                                            {(() => {
                                                const oggi = new Date().toISOString().split('T')[0];
                                                const totali = totaliGiornalieri(oggi);
                                                return (
                                                    <div className="grid grid-cols-2 sm:flex sm:flex-wrap gap-2 sm:gap-3">
                                                        <div className={`px-3 py-2 rounded-lg shadow ${cardClass}`}>
                                                            <span className={`text-xs sm:text-sm ${textSecondary}`}>Calorie</span>
                                                            <p className="text-lg sm:text-xl font-bold text-red-600">{totali.calorie.toFixed(0)}</p>
                                                        </div>
                                                        <div className={`px-3 py-2 rounded-lg shadow ${cardClass}`}>
                                                            <span className={`text-xs sm:text-sm ${textSecondary}`}>Proteine</span>
                                                            <p className="text-lg sm:text-xl font-bold text-blue-600">{totali.proteine.toFixed(1)}g</p>
                                                        </div>
                                                        <div className={`px-3 py-2 rounded-lg shadow ${cardClass}`}>
                                                            <span className={`text-xs sm:text-sm ${textSecondary}`}>Carboidrati</span>
                                                            <p className="text-lg sm:text-xl font-bold text-yellow-600">{totali.carboidrati.toFixed(1)}g</p>
                                                        </div>
                                                        <div className={`px-3 py-2 rounded-lg shadow ${cardClass}`}>
                                                            <span className={`text-xs sm:text-sm ${textSecondary}`}>Grassi</span>
                                                            <p className="text-lg sm:text-xl font-bold text-green-600">{totali.grassi.toFixed(1)}g</p>
                                                        </div>
                                                    </div>
                                                );
                                            })()}
                                        </div>
                                    )}

                                    <div className="space-y-4">
                                        {(() => {
                                            // Raggruppa i pasti per data e tipo pasto
                                            const pastiRaggruppati = {};
                                            [...pasti].reverse().forEach(pasto => {
                                                const data = pasto.data;
                                                if (!pastiRaggruppati[data]) {
                                                    pastiRaggruppati[data] = {};
                                                }
                                                const tipoPasto = pasto.tipoPasto || 'Altro';
                                                if (!pastiRaggruppati[data][tipoPasto]) {
                                                    pastiRaggruppati[data][tipoPasto] = [];
                                                }
                                                pastiRaggruppati[data][tipoPasto].push(pasto);
                                            });

                                            // Ordina le date e prendi solo i giorni visibili
                                            const dateOrdinate = Object.keys(pastiRaggruppati).sort((a, b) => b.localeCompare(a));
                                            const dateVisibili = dateOrdinate.slice(0, giorniVisibili);
                                            const ciSonoAltriGiorni = dateOrdinate.length > giorniVisibili;

                                            return (
                                                <>
                                                    {dateVisibili.map((data, idx) => {
                                                        const pastiPerTipo = pastiRaggruppati[data];
                                                        const oggi = new Date().toISOString().split('T')[0];
                                                        const isOggi = data === oggi;
                                                        const isEspanso = giorniEspansi.has(data);

                                                        // Calcola totali del giorno
                                                        const totaliGiorno = totaliGiornalieri(data);

                                                        // Calcola totali per tipo pasto
                                                        const totaliPerPasto = {};
                                                        Object.entries(pastiPerTipo).forEach(([tipoPasto, pastiDelTipo]) => {
                                                            totaliPerPasto[tipoPasto] = pastiDelTipo.reduce((acc, p) => ({
                                                                calorie: acc.calorie + (parseFloat(p.macro.calorie) || 0),
                                                                proteine: acc.proteine + (parseFloat(p.macro.proteine) || 0),
                                                                carboidrati: acc.carboidrati + (parseFloat(p.macro.carboidrati) || 0),
                                                                grassi: acc.grassi + (parseFloat(p.macro.grassi) || 0)
                                                            }), { calorie: 0, proteine: 0, carboidrati: 0, grassi: 0 });
                                                        });

                                                        return (
                                                            <div key={data} className={`border-2 rounded-lg overflow-hidden transition-all ${
                                                                isOggi
                                                                    ? 'border-purple-400 shadow-lg'
                                                                    : 'border-purple-200'
                                                            } ${cardClass}`}>
                                                                {/* Header cliccabile */}
                                                                <div
                                                                    onClick={() => !isOggi && toggleEspansioneGiorno(data)}
                                                                    className={`p-3 sm:p-4 ${!isOggi ? 'cursor-pointer hover:opacity-80' : ''} ${
                                                                        isOggi ? (darkMode ? 'bg-purple-900/30' : 'bg-purple-50') : ''
                                                                    }`}
                                                                >
                                                                    <div className="flex justify-between items-start mb-2">
                                                                        <div>
                                                                            <h3 className={`font-bold text-lg ${isOggi ? 'text-purple-700' : textClass}`}>
                                                                                {isOggi ? 'üìÖ Oggi' : ''} {new Date(data + 'T00:00:00').toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' })}
                                                                            </h3>
                                                                            {!isOggi && !isEspanso && (
                                                                                <p className={`text-xs ${textSecondary}`}>Click per espandere</p>
                                                                            )}
                                                                        </div>
                                                                        {!isOggi && (
                                                                            <div className="text-purple-600">
                                                                                {isEspanso ? '‚ñº' : '‚ñ∂'}
                                                                            </div>
                                                                        )}
                                                                    </div>

                                                                    {/* Totali giorno sempre visibili */}
                                                                    <div className="flex flex-wrap gap-2">
                                                                        <span className={`text-xs px-2 py-1 rounded ${darkMode ? 'bg-red-900/50 text-red-200' : 'bg-red-100 text-red-700'}`}>
                                                                            {totaliGiorno.calorie.toFixed(0)} kcal
                                                                        </span>
                                                                        <span className={`text-xs px-2 py-1 rounded ${darkMode ? 'bg-blue-900/50 text-blue-200' : 'bg-blue-100 text-blue-700'}`}>
                                                                            P: {totaliGiorno.proteine.toFixed(1)}g
                                                                        </span>
                                                                        <span className={`text-xs px-2 py-1 rounded ${darkMode ? 'bg-yellow-900/50 text-yellow-200' : 'bg-yellow-100 text-yellow-700'}`}>
                                                                            C: {totaliGiorno.carboidrati.toFixed(1)}g
                                                                        </span>
                                                                        <span className={`text-xs px-2 py-1 rounded ${darkMode ? 'bg-green-900/50 text-green-200' : 'bg-green-100 text-green-700'}`}>
                                                                            G: {totaliGiorno.grassi.toFixed(1)}g
                                                                        </span>
                                                                    </div>
                                                                </div>

                                                                {/* Contenuto espandibile */}
                                                                {isEspanso && (
                                                                    <div className={`p-3 sm:p-4 border-t ${darkMode ? 'border-gray-700' : 'border-purple-100'}`}>
                                                                        {tipiPasto
                                                                            .filter(tipo => pastiPerTipo[tipo])
                                                                            .map(tipoPasto => {
                                                                                const pastiDelTipo = pastiPerTipo[tipoPasto];
                                                                                return (
                                                                            <div key={tipoPasto} className="mb-4 last:mb-0">
                                                                                {/* Header tipo pasto con totali */}
                                                                                <div className="flex flex-wrap items-center gap-2 mb-2">
                                                                                    <h4 className="font-semibold text-sm text-purple-600">
                                                                                        <span className={`px-2 py-1 rounded ${darkMode ? 'bg-purple-900/50' : 'bg-purple-100'}`}>
                                                                                            {tipoPasto}
                                                                                        </span>
                                                                                    </h4>
                                                                                    <div className="flex flex-wrap gap-1">
                                                                                        <span className="text-xs bg-red-100 text-red-700 px-1.5 py-0.5 rounded">
                                                                                            {totaliPerPasto[tipoPasto].calorie.toFixed(0)} kcal
                                                                                        </span>
                                                                                        <span className="text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded">
                                                                                            P: {totaliPerPasto[tipoPasto].proteine.toFixed(1)}g
                                                                                        </span>
                                                                                        <span className="text-xs bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded">
                                                                                            C: {totaliPerPasto[tipoPasto].carboidrati.toFixed(1)}g
                                                                                        </span>
                                                                                        <span className="text-xs bg-green-100 text-green-700 px-1.5 py-0.5 rounded">
                                                                                            G: {totaliPerPasto[tipoPasto].grassi.toFixed(1)}g
                                                                                        </span>
                                                                                    </div>
                                                                                </div>

                                                                                {/* Lista pasti */}
                                                                                <div className="space-y-2 ml-0 sm:ml-4">
                                                                                    {pastiDelTipo.map(pasto => (
                                                                                        <div key={pasto.id} className={`border rounded-lg p-2 sm:p-3 transition ${bgAccent} hover:opacity-80`}>
                                                                                            <div className="flex justify-between items-start gap-2 mb-2">
                                                                                                <div className="flex-1">
                                                                                                    <h5 className={`font-semibold text-sm ${textClass}`}>{pasto.nome}</h5>
                                                                                                    <p className={`text-xs ${textSecondary}`}>
                                                                                                        {pasto.quantita} {pasto.unita}
                                                                                                    </p>
                                                                                                </div>
                                                                                                <button
                                                                                                    onClick={() => eliminaPasto(pasto.id)}
                                                                                                    className="text-red-600 hover:text-red-700 p-1 min-w-[36px] min-h-[36px] flex items-center justify-center flex-shrink-0"
                                                                                                >
                                                                                                    <Trash2 />
                                                                                                </button>
                                                                                            </div>
                                                                                            <div className="flex flex-wrap gap-1 text-xs">
                                                                                                <span className="bg-red-100 text-red-700 px-2 py-1 rounded">
                                                                                                    {pasto.macro.calorie} kcal
                                                                                                </span>
                                                                                                <span className="bg-blue-100 text-blue-700 px-2 py-1 rounded">
                                                                                                    P: {pasto.macro.proteine}g
                                                                                                </span>
                                                                                                <span className="bg-yellow-100 text-yellow-700 px-2 py-1 rounded">
                                                                                                    C: {pasto.macro.carboidrati}g
                                                                                                </span>
                                                                                                <span className="bg-green-100 text-green-700 px-2 py-1 rounded">
                                                                                                    G: {pasto.macro.grassi}g
                                                                                                </span>
                                                                                            </div>
                                                                                        </div>
                                                                                    ))}
                                                                                </div>
                                                                            </div>
                                                                                );
                                                                            })}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })}

                                                    {/* Pulsante Vedi altri */}
                                                    {ciSonoAltriGiorni && (
                                                        <div className="flex justify-center">
                                                            <button
                                                                onClick={caricaAltriGiorni}
                                                                className={`px-6 py-3 rounded-lg font-semibold transition ${
                                                                    darkMode
                                                                        ? 'bg-purple-700 hover:bg-purple-600 text-white'
                                                                        : 'bg-purple-100 hover:bg-purple-200 text-purple-700'
                                                                }`}
                                                            >
                                                                ‚¨áÔ∏è Carica altri 7 giorni
                                                            </button>
                                                        </div>
                                                    )}
                                                </>
                                            );
                                        })()}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<CucinaApp />, document.getElementById('root'));
    </script>
</body>
</html>